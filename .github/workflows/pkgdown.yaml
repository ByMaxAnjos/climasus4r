name: Build and Deploy Multilingual pkgdown Site

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'
      
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev
      
      - name: Install R dependencies
        run: |
          install.packages(c("remotes", "pkgdown", "dplyr", "stringi", "cli", "lubridate", "magrittr", "digest", "tidyr", "fs", "rlang", "future.apply", "progressr", "stringr", "future", "arrow", "sfarrow", "geobr", "geocodebr", "sf", "data.table", "knitr", "rmarkdown", "ggplot2"))
          remotes::install_github("rfsaldanha/microdatasus")
        shell: Rscript {0}
      
      - name: Create deployment directory
        run: mkdir -p deploy
      
      - name: Build Portuguese site
        run: |
          # Use Portuguese README
          cp README-pt.md README.md
          
          # Copy vignettes
          mkdir -p vignettes
          cp -r vignettes-pt/* vignettes/
          
          # Copy pkgdown config
          cp _pkgdown-pt.yml _pkgdown.yml
          
          # Build site
          Rscript -e 'pkgdown::build_site()'
          
          # Move to deployment folder
          mkdir -p deploy/pt
          cp -r docs/* deploy/pt/
          
          # Clean up
          rm -rf docs vignettes README.md _pkgdown.yml
      
      - name: Build English site
        run: |
          # Use English README
          cp README-en.md README.md
          
          # Copy vignettes
          mkdir -p vignettes
          cp -r vignettes-en/* vignettes/
          
          # Copy pkgdown config
          cp _pkgdown-en.yml _pkgdown.yml
          
          # Build site
          Rscript -e 'pkgdown::build_site()'
          
          # Move to deployment folder
          mkdir -p deploy/en
          cp -r docs/* deploy/en/
          
          # Clean up
          rm -rf docs vignettes README.md _pkgdown.yml
      
      - name: Build Spanish site
        run: |
          # Use Spanish README
          cp README-es.md README.md
          
          # Copy vignettes
          mkdir -p vignettes
          cp -r vignettes-es/* vignettes/
          
          # Copy pkgdown config
          cp _pkgdown-es.yml _pkgdown.yml
          
          # Build site
          Rscript -e 'pkgdown::build_site()'
          
          # Move to deployment folder
          mkdir -p deploy/es
          cp -r docs/* deploy/es/
          
          # Clean up
          rm -rf docs vignettes README.md _pkgdown.yml
      
      - name: Copy landing page and assets
        run: |
          # Copy the main landing page (language selector)
          cp index.html deploy/
          
          # Copy pkgdown assets to all language directories
          mkdir -p deploy/pt/pkgdown deploy/en/pkgdown deploy/es/pkgdown
          cp -r pkgdown/* deploy/pt/pkgdown/
          cp -r pkgdown/* deploy/en/pkgdown/
          cp -r pkgdown/* deploy/es/pkgdown/
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          force_orphan: true
