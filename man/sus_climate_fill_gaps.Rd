% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sus_climate_fill_gap.R
\name{sus_climate_fill_gaps}
\alias{sus_climate_fill_gaps}
\title{Fill gaps in climate and air-quality time series using XGBoost}
\usage{
sus_climate_fill_gaps(
  df,
  target_var,
  datetime_col = NULL,
  station_col = NULL,
  quality_threshold = 0.4,
  run_evaluation = FALSE,
  gap_percentage = 0.2,
  keep_features = FALSE,
  parallel = TRUE,
  workers = NULL,
  verbose = TRUE,
  lang = "pt"
)
}
\arguments{
\item{df}{A data frame (or tibble) containing climate data, typically from \code{sus_climate_inmet()}.
Must contain:
\itemize{
\item A datetime column (POSIXct or convertible)
\item A station identifier column
\item The target numeric column to be imputed
}}

\item{target_var}{\strong{Single} character string specifying the column to impute.
Example: \code{target_var = "tair_dry_bulb_c"}.}

\item{datetime_col}{Character. Name of the datetime column. If \code{NULL} (default), auto-detected.}

\item{station_col}{Character. Name of the station identifier column. If \code{NULL}, auto-detected.}

\item{quality_threshold}{Numeric (0-1). Maximum allowed missing proportion per station.
Stations exceeding this are excluded. Default: \code{0.4} (40\%).}

\item{run_evaluation}{Logical. If \code{TRUE}, runs in evaluation mode:
\itemize{
\item Creates artificial MCAR gaps in observed data
\item Imputes and compares predictions with true values
\item Returns metrics by station
}
Default: \code{FALSE} (production mode).}

\item{gap_percentage}{Numeric (0-1). Proportion of data to set as missing in evaluation mode. The \code{"MCAR"} Missing Completely At Random is used as default.
Default: \code{0.2} (20\%).}

\item{keep_features}{Logical. If \code{TRUE}, retains engineered features (lags, rolling stats).
Default: \code{FALSE} (returns only original columns + \code{is_imputed}).}

\item{parallel}{Logical. If \code{TRUE} (default), processes stations in parallel using \code{furrr}.}

\item{workers}{Integer. Number of parallel workers. If \code{NULL}, uses \code{availableCores() - 1}.}

\item{verbose}{Logical. If \code{TRUE} (default), prints progress messages.}

\item{lang}{Character. Message language: \code{"pt"} (Portuguese), \code{"en"} (English), or \code{"es"} (Spanish).
Default: \code{"pt"}.}
}
\value{
\strong{Production mode} (\code{run_evaluation = FALSE}):
Returns a \code{tibble} (same class as input) with:
\itemize{
\item Original columns plus imputed values in \code{target_var}
\item \code{is_imputed}: Logical flag (TRUE for filled values)
\item \code{climasus_meta} attribute with imputation metadata
}

\strong{Evaluation mode} (\code{run_evaluation = TRUE}):
Returns a list of class \code{climasus_eval} containing:
\itemize{
\item \verb{$data}: Data frame with artificial gaps and predictions
\item \verb{$metrics}: A \code{tibble} with per-station performance metrics:
\itemize{
\item \code{station}: Station identifier
\item \code{rmse}: Root Mean Squared Error
\item \code{mae}: Mean Absolute Error
\item \code{r_squared}: R-squared (lower than 1, higher is better)
\item \code{smape}: Symmetric MAPE (0-200\%, lower is better)
\item \code{slope_bias}: Should be close to 1.0, indicating underestimate and overestimate
\item \code{n_gaps}: Number of artificial gaps
}
}
}
\description{
\code{sus_climate_fill_gaps()} imputes missing values in climate time series using
station-wise XGBoost models with automated feature engineering.

\strong{Key features:}
\itemize{
\item \strong{Single-target focus}: Each call imputes ONE variable
\item \strong{Station-wise modeling}: Separate model per station
\item \strong{Temporal features}: Automatic creation of lags and rolling statistics
\item \strong{Quality control}: Stations with >\code{quality_threshold} missing are excluded
\item \strong{Parallel processing}: Stations processed in parallel for speed
\item \strong{Evaluation mode}: Assess accuracy by creating artificial gaps
}
}
\section{Methodological Notes}{


\strong{Important limitations:}
\itemize{
\item \strong{Not forecasting}: Predicts only where data are missing
\item \strong{No future data}: Uses only past information (lags)
\item \strong{Station independence}: Models don't share information
\item \strong{Quality filter}: Stations with >\code{quality_threshold} missing are skipped
}

\strong{Feature engineering:}
Automatically creates:
\itemize{
\item Time features: hour, day, month, year, cyclic transforms
\item Lag features: 1,2,3,6,12,24,48,72,168 periods
\item Rolling statistics: mean and sd over windows 3,6,12,24,48,72
}
}

\section{Evaluation Mode Details}{


When \code{run_evaluation = TRUE}, the function:
\enumerate{
\item Creates artificial gaps (MCAR by default)
\item Runs imputation on the data with gaps
\item Compares predictions with true values
\item Returns per-station performance
}

This helps assess model accuracy before production use.
}

\examples{
\dontrun{
# ===== PRODUCTION MODE =====
# Impute missing temperature data
filled_temp <- sus_climate_fill_gaps(
  df = climate_data,
  target_var = "tair_dry_bulb_c",
  quality_threshold = 0.3,
  parallel = TRUE
)


# ===== EVALUATION MODE =====
# Assess model performance on a subset
eval_results <- sus_climate_fill_gaps(
  df = climate_data,
  target_var = "ws_2_m_s",
  run_evaluation = TRUE,
  gap_percentage = 0.2,
  workers = 4
)

# View performance metrics
eval_results$metrics

}

}
